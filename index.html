<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Miernik ciśnienia — PWA</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0b6cf0" />

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Miernik Ciśn.">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<link rel="icon" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon-180.png">
<link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">

<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --accent:#0b6cf0; --muted:#6b7280;
    --ok:#10b981; --ok2:#22c55e; --warn:#f59e0b; --bad:#ef4444; --crisis:#b91c1c;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:18px auto;padding:14px}
  header{display:flex;align-items:center;gap:12px}
  header h1{font-size:1.1rem;margin:0}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 1px 6px rgba(16,24,40,.06);margin-top:12px}
  form .row{display:flex;gap:8px;align-items:flex-end;margin-bottom:8px;flex-wrap:wrap}
  input[type=number],input[type=datetime-local],input[type=text],textarea,select{
    padding:8px;border-radius:8px;border:1px solid #e6e9ef;background:white
  }
  input[type=text],textarea,select{min-width:220px}
  input[type=number]{width:120px}
  input[type=datetime-local]{min-width:220px}
  label{font-size:0.85rem;color:var(--muted);display:block;margin-bottom:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
  button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #e6e9ef}
  button.danger{background:transparent;color:var(--bad);border:1px solid #fee2e2}
  .list{margin-top:12px}
  table{width:100%;border-collapse:collapse;font-size:0.95rem}
  th,td{padding:8px;border-bottom:1px solid #f1f3f7;text-align:left;vertical-align:top}
  th{white-space:nowrap}
  .small{font-size:0.85rem;color:var(--muted)}
  .chartwrap{margin-top:12px;padding:8px}
  canvas{width:100%;height:220px;border-radius:8px;background:linear-gradient(180deg,#fff, #fbfdff)}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:0.78rem;font-weight:800;border:1px solid #e6e9ef}
  .pill.opt{color:var(--ok);border-color:#d1fae5;background:#ecfdf5}
  .pill.norm{color:var(--ok2);border-color:#dcfce7;background:#f0fdf4}
  .pill.hnorm{color:var(--warn);border-color:#fde68a;background:#fffbeb}
  .pill.htn{color:var(--bad);border-color:#fecaca;background:#fef2f2}
  .pill.crisis{color:var(--crisis);border-color:#fecaca;background:#fee2e2}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:10px}
  .kpi .box{border:1px solid #eef2f7;border-radius:12px;padding:10px}
  .kpi .val{font-weight:800;font-size:1.05rem}
  .kpi .lbl{font-size:0.78rem;color:var(--muted);margin-top:4px}
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;margin-top:10px}
  .filters .f{display:flex;flex-direction:column}
  .toast{
    position:fixed;left:12px;right:12px;bottom:12px;
    background:#111;color:#fff;border-radius:12px;padding:10px 12px;
    box-shadow:0 8px 30px rgba(0,0,0,.18);
    display:none;align-items:center;gap:10px;z-index:9999;
    max-width:980px;margin:0 auto;
  }
  .toast .txt{flex:1;font-size:0.95rem}
  .toast button{background:#fff;color:#111;border:0}
  dialog{
    border:0;border-radius:14px;max-width:820px;width:calc(100% - 28px);
    padding:0;box-shadow:0 16px 60px rgba(0,0,0,.25);
  }
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .modalHead{padding:12px 12px 0 12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .modalBody{padding:12px}
  .modalFoot{padding:0 12px 12px 12px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .xbtn{background:transparent;border:1px solid #e6e9ef;color:#111}
  .muted{color:var(--muted)}
  @media(max-width:820px){
    .kpi{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
  /* Telefon / wąskie ekrany: nie pozwól polom wymuszać min-width i rozpychać layoutu */
@media (max-width: 640px){
  /* najważniejsze: wyłącz min-width, bo to robi overflow */
  input[type=text], textarea, select, input[type=datetime-local]{
    min-width: 0 !important;
    width: 100%;
    box-sizing: border-box;
  }

  /* kontenery w wierszu niech nie mają własnych minimalnych szerokości */
  form .row > div{
    min-width: 0 !important;
    width: 100% !important;
    flex: 1 1 100%;
  }

  /* checkboxy: niech się ładnie łamią */
  #measureForm .row label{
    max-width: 100%;
  }
}
  /* zapobiega poziomemu rozpychaniu całej aplikacji */
html, body { overflow-x: hidden; }

/* tabela może się przewijać w poziomie zamiast rozpychać layout */
.list { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.list table { min-width: 760px; }  /* wymusza sensowną szerokość tabeli */

/* iPhone Safari: nie zoomuj strony po tapnięciu w pole */
input, select, textarea, button {
  font-size: 16px !important;
}

/* opcjonalnie: spójne labelki (bez wpływu na zoom) */
#measureForm label, #dlgForm label { font-size: 14px; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="icons/icon-192.png" width="42" height="42" alt="logo">
    <div>
      <h1>Miernik ciśnienia — PWA</h1>
      <div class="small">Szybki zapis pomiarów ciśnienia i tętna. Działa offline.</div>
    </div>
  </header>

  <div class="card" id="entryCard">
    <form id="measureForm">
      <div class="row">
        <div>
          <label for="ts">Data i godzina</label>
          <input id="ts" type="datetime-local" required />
        </div>
        <div>
          <label for="sys">Skurczowe (mmHg)</label>
          <input id="sys" type="number" min="40" max="300" required />
        </div>
        <div>
          <label for="dia">Rozkurczowe (mmHg)</label>
          <input id="dia" type="number" min="30" max="200" required />
        </div>
        <div>
          <label for="pulse">Tętno (bpm)</label>
          <input id="pulse" type="number" min="20" max="220" />
        </div>
        <div>
          <label for="pos">Pozycja</label>
          <select id="pos">
            <option value="">—</option>
            <option value="siedzaca">Siedząca</option>
            <option value="lezaca">Leżąca</option>
            <option value="stojaca">Stojąca</option>
          </select>
        </div>
        <div>
          <label>Kontekst</label>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
              <input id="rested" type="checkbox"> po 5 min odpoczynku
            </label>
            <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
              <input id="meds" type="checkbox"> leki wzięte
            </label>
          </div>
        </div>
      </div>

      <div style="margin-top:6px">
        <label for="note">Notatka (np. leki, objawy)</label>
        <input id="note" type="text" placeholder="np. po spacerze, ból głowy, amlodypina" />
      </div>

      <div class="controls">
        <button id="saveBtn" type="submit">Zapisz pomiar</button>
        <button id="clearBtn" type="button" class="ghost">Wyczyść formularz</button>
        <div style="flex:1"></div>
        <div class="actions">
          <button id="exportCsv" type="button" class="ghost">Eksport CSV</button>
          <button id="importCsvBtn" type="button" class="ghost">Import CSV</button>
          <input id="importCsv" type="file" accept=".csv" style="display:none" />
          <button id="exportJson" type="button" class="ghost">Kopia JSON</button>
          <button id="importJsonBtn" type="button" class="ghost">Przywróć JSON</button>
          <input id="importJson" type="file" accept=".json" style="display:none" />
          <button id="printReport" type="button" class="ghost">Raport / druk</button>
          <button id="resetAll" type="button" class="danger">Usuń wszystkie</button>
        </div>
      </div>
    </form>
  </div>

  <div class="card">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <strong>Historia pomiarów</strong>
        <div class="small">Edytuj w oknie dialogowym • Filtruj • Szukaj w notatkach</div>
      </div>
      <div class="small muted" id="countInfo"></div>
    </div>

    <div class="kpi" id="kpi"></div>

    <div class="filters">
      <div class="f">
        <label for="rangeSel">Zakres</label>
        <select id="rangeSel">
          <option value="all">Wszystkie</option>
          <option value="7">Ostatnie 7 dni</option>
          <option value="30" selected>Ostatnie 30 dni</option>
          <option value="90">Ostatnie 90 dni</option>
        </select>
      </div>
      <div class="f">
        <label for="sortSel">Sortowanie</label>
        <select id="sortSel">
          <option value="desc" selected>Najnowsze → najstarsze</option>
          <option value="asc">Najstarsze → najnowsze</option>
        </select>
      </div>
      <div class="f" style="flex:1;min-width:240px">
        <label for="searchNote">Szukaj (notatka/kontekst)</label>
        <input id="searchNote" type="text" placeholder="np. amlodypina, spacer, ból" />
      </div>
    </div>

    <div class="list" id="listWrap"></div>
  </div>

  <div class="card chartwrap">
    <strong>Wykres (ostatnie 30 pomiarów)</strong>
    <canvas id="chart"></canvas>
    <div class="small" style="margin-top:6px">Status wg ESC/ESH (Europa): optymalne, prawidłowe, wysokie prawidłowe, nadciśnienie (+ alert ≥180/120).</div>
  </div>

  <footer style="margin-top:12px;text-align:center" class="small card">
    Dane przechowywane lokalnie w urządzeniu. Działa offline.
  </footer>
</div>

<div class="toast" id="toast">
  <div class="txt" id="toastTxt">Nowa wersja aplikacji jest dostępna.</div>
  <button id="reloadBtn" type="button">Odśwież</button>
  <button id="dismissBtn" type="button" class="ghost" style="border:1px solid rgba(255,255,255,.25);color:#fff;background:transparent">Później</button>
</div>

<dialog id="editDlg">
  <div class="modalHead">
    <div>
      <strong id="dlgTitle">Edytuj pomiar</strong>
      <div class="small muted" id="dlgSub">Zmień dane i zapisz.</div>
    </div>
    <button class="xbtn" id="dlgClose" type="button">Zamknij</button>
  </div>
  <div class="modalBody">
    <form id="dlgForm">
      <div class="row">
        <div>
          <label for="d_ts">Data i godzina</label>
          <input id="d_ts" type="datetime-local" required />
        </div>
        <div>
          <label for="d_sys">Skurczowe</label>
          <input id="d_sys" type="number" min="40" max="300" required />
        </div>
        <div>
          <label for="d_dia">Rozkurczowe</label>
          <input id="d_dia" type="number" min="30" max="200" required />
        </div>
        <div>
          <label for="d_pulse">Tętno</label>
          <input id="d_pulse" type="number" min="20" max="220" />
        </div>
        <div>
          <label for="d_pos">Pozycja</label>
          <select id="d_pos">
            <option value="">—</option>
            <option value="siedzaca">Siedząca</option>
            <option value="lezaca">Leżąca</option>
            <option value="stojaca">Stojąca</option>
          </select>
        </div>
      </div>

      <div style="margin-top:6px">
        <label>Kontekst</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
            <input id="d_rested" type="checkbox"> po 5 min odpoczynku
          </label>
          <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
            <input id="d_meds" type="checkbox"> leki wzięte
          </label>
        </div>
      </div>

      <div style="margin-top:6px">
        <label for="d_note">Notatka</label>
        <input id="d_note" type="text" />
      </div>
    </form>
  </div>
  <div class="modalFoot">
    <button id="dlgDelete" type="button" class="danger">Usuń</button>
    <div style="flex:1"></div>
    <button id="dlgCancel" type="button" class="ghost">Anuluj</button>
    <button id="dlgSave" type="button">Zapisz zmiany</button>
  </div>
</dialog>

<script>
/* … TWÓJ OBECNY JS BEZ ZMIAN … */
</script>
</body>
</html>
