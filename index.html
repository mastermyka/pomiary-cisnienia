<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Miernik ciśnienia — PWA</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0b6cf0" />

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Miernik Ciśn.">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<link rel="icon" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon-180.png">
<link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">

<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --accent:#0b6cf0; --muted:#6b7280;
    --ok:#10b981; --ok2:#22c55e; --warn:#f59e0b; --bad:#ef4444; --crisis:#b91c1c;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:18px auto;padding:14px}
  header{display:flex;align-items:center;gap:12px}
  header h1{font-size:1.1rem;margin:0}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 1px 6px rgba(16,24,40,.06);margin-top:12px}
  form .row{display:flex;gap:8px;align-items:flex-end;margin-bottom:8px;flex-wrap:wrap}
  input[type=number],input[type=datetime-local],input[type=text],textarea,select{
    padding:8px;border-radius:8px;border:1px solid #e6e9ef;background:white
  }
  input[type=text],textarea,select{min-width:220px}
  input[type=number]{width:120px}
  input[type=datetime-local]{min-width:220px}
  label{font-size:0.85rem;color:var(--muted);display:block;margin-bottom:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
  button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #e6e9ef}
  button.danger{background:transparent;color:var(--bad);border:1px solid #fee2e2}
  .list{margin-top:12px}
  table{width:100%;border-collapse:collapse;font-size:0.95rem}
  th,td{padding:8px;border-bottom:1px solid #f1f3f7;text-align:left;vertical-align:top}
  th{white-space:nowrap}
  .small{font-size:0.85rem;color:var(--muted)}
  .chartwrap{margin-top:12px;padding:8px}
  canvas{width:100%;height:220px;border-radius:8px;background:linear-gradient(180deg,#fff, #fbfdff)}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:0.78rem;font-weight:800;border:1px solid #e6e9ef}
  .pill.opt{color:var(--ok);border-color:#d1fae5;background:#ecfdf5}
  .pill.norm{color:var(--ok2);border-color:#dcfce7;background:#f0fdf4}
  .pill.hnorm{color:var(--warn);border-color:#fde68a;background:#fffbeb}
  .pill.htn{color:var(--bad);border-color:#fecaca;background:#fef2f2}
  .pill.crisis{color:var(--crisis);border-color:#fecaca;background:#fee2e2}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:10px}
  .kpi .box{border:1px solid #eef2f7;border-radius:12px;padding:10px}
  .kpi .val{font-weight:800;font-size:1.05rem}
  .kpi .lbl{font-size:0.78rem;color:var(--muted);margin-top:4px}
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;margin-top:10px}
  .filters .f{display:flex;flex-direction:column}
  .toast{
    position:fixed;left:12px;right:12px;bottom:12px;
    background:#111;color:#fff;border-radius:12px;padding:10px 12px;
    box-shadow:0 8px 30px rgba(0,0,0,.18);
    display:none;align-items:center;gap:10px;z-index:9999;
    max-width:980px;margin:0 auto;
  }
  .toast .txt{flex:1;font-size:0.95rem}
  .toast button{background:#fff;color:#111;border:0}
  dialog{
    border:0;border-radius:14px;max-width:820px;width:calc(100% - 28px);
    padding:0;box-shadow:0 16px 60px rgba(0,0,0,.25);
  }
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .modalHead{padding:12px 12px 0 12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .modalBody{padding:12px}
  .modalFoot{padding:0 12px 12px 12px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .xbtn{background:transparent;border:1px solid #e6e9ef;color:#111}
  .muted{color:var(--muted)}
  @media(max-width:820px){
    .kpi{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
  /* Telefon / wąskie ekrany: nie pozwól polom wymuszać min-width i rozpychać layoutu */
@media (max-width: 640px){
  /* najważniejsze: wyłącz min-width, bo to robi overflow */
  input[type=text], textarea, select, input[type=datetime-local]{
    min-width: 0 !important;
    width: 100%;
    box-sizing: border-box;
  }

  /* kontenery w wierszu niech nie mają własnych minimalnych szerokości */
  form .row > div{
    min-width: 0 !important;
    width: 100% !important;
    flex: 1 1 100%;
  }

  /* checkboxy: niech się ładnie łamią */
  #measureForm .row label{
    max-width: 100%;
  }
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="icons/icon-192.png" width="42" height="42" alt="logo">
    <div>
      <h1>Miernik ciśnienia — PWA</h1>
      <div class="small">Szybki zapis pomiarów ciśnienia i tętna. Działa offline.</div>
    </div>
  </header>

  <div class="card" id="entryCard">
    <form id="measureForm">
      <div class="row">
        <div>
          <label for="ts">Data i godzina</label>
          <input id="ts" type="datetime-local" required />
        </div>
        <div>
          <label for="sys">Skurczowe (mmHg)</label>
          <input id="sys" type="number" min="40" max="300" required />
        </div>
        <div>
          <label for="dia">Rozkurczowe (mmHg)</label>
          <input id="dia" type="number" min="30" max="200" required />
        </div>
        <div>
          <label for="pulse">Tętno (bpm)</label>
          <input id="pulse" type="number" min="20" max="220" />
        </div>
        <div>
          <label for="pos">Pozycja</label>
          <select id="pos">
            <option value="">—</option>
            <option value="siedzaca">Siedząca</option>
            <option value="lezaca">Leżąca</option>
            <option value="stojaca">Stojąca</option>
          </select>
        </div>
        <div>
          <label>Kontekst</label>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
              <input id="rested" type="checkbox"> po 5 min odpoczynku
            </label>
            <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
              <input id="meds" type="checkbox"> leki wzięte
            </label>
          </div>
        </div>
      </div>

      <div style="margin-top:6px">
        <label for="note">Notatka (np. leki, objawy)</label>
        <input id="note" type="text" placeholder="np. po spacerze, ból głowy, amlodypina" />
      </div>

      <div class="controls">
        <button id="saveBtn" type="submit">Zapisz pomiar</button>
        <button id="clearBtn" type="button" class="ghost">Wyczyść formularz</button>
        <div style="flex:1"></div>
        <div class="actions">
          <button id="exportCsv" type="button" class="ghost">Eksport CSV</button>
          <button id="importCsvBtn" type="button" class="ghost">Import CSV</button>
          <input id="importCsv" type="file" accept=".csv" style="display:none" />
          <button id="exportJson" type="button" class="ghost">Kopia JSON</button>
          <button id="importJsonBtn" type="button" class="ghost">Przywróć JSON</button>
          <input id="importJson" type="file" accept=".json" style="display:none" />
          <button id="printReport" type="button" class="ghost">Raport / druk</button>
          <button id="resetAll" type="button" class="danger">Usuń wszystkie</button>
        </div>
      </div>
    </form>
  </div>

  <div class="card">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <strong>Historia pomiarów</strong>
        <div class="small">Edytuj w oknie dialogowym • Filtruj • Szukaj w notatkach</div>
      </div>
      <div class="small muted" id="countInfo"></div>
    </div>

    <div class="kpi" id="kpi"></div>

    <div class="filters">
      <div class="f">
        <label for="rangeSel">Zakres</label>
        <select id="rangeSel">
          <option value="all">Wszystkie</option>
          <option value="7">Ostatnie 7 dni</option>
          <option value="30" selected>Ostatnie 30 dni</option>
          <option value="90">Ostatnie 90 dni</option>
        </select>
      </div>
      <div class="f">
        <label for="sortSel">Sortowanie</label>
        <select id="sortSel">
          <option value="desc" selected>Najnowsze → najstarsze</option>
          <option value="asc">Najstarsze → najnowsze</option>
        </select>
      </div>
      <div class="f" style="flex:1;min-width:240px">
        <label for="searchNote">Szukaj (notatka/kontekst)</label>
        <input id="searchNote" type="text" placeholder="np. amlodypina, spacer, ból" />
      </div>
    </div>

    <div class="list" id="listWrap"></div>
  </div>

  <div class="card chartwrap">
    <strong>Wykres (ostatnie 30 pomiarów)</strong>
    <canvas id="chart"></canvas>
    <div class="small" style="margin-top:6px">Status wg ESC/ESH (Europa): optymalne, prawidłowe, wysokie prawidłowe, nadciśnienie (+ alert ≥180/120).</div>
  </div>

  <footer style="margin-top:12px;text-align:center" class="small card">
    Dane przechowywane lokalnie w urządzeniu. Działa offline.
  </footer>
</div>

<div class="toast" id="toast">
  <div class="txt" id="toastTxt">Nowa wersja aplikacji jest dostępna.</div>
  <button id="reloadBtn" type="button">Odśwież</button>
  <button id="dismissBtn" type="button" class="ghost" style="border:1px solid rgba(255,255,255,.25);color:#fff;background:transparent">Później</button>
</div>

<dialog id="editDlg">
  <div class="modalHead">
    <div>
      <strong id="dlgTitle">Edytuj pomiar</strong>
      <div class="small muted" id="dlgSub">Zmień dane i zapisz.</div>
    </div>
    <button class="xbtn" id="dlgClose" type="button">Zamknij</button>
  </div>
  <div class="modalBody">
    <form id="dlgForm">
      <div class="row">
        <div>
          <label for="d_ts">Data i godzina</label>
          <input id="d_ts" type="datetime-local" required />
        </div>
        <div>
          <label for="d_sys">Skurczowe</label>
          <input id="d_sys" type="number" min="40" max="300" required />
        </div>
        <div>
          <label for="d_dia">Rozkurczowe</label>
          <input id="d_dia" type="number" min="30" max="200" required />
        </div>
        <div>
          <label for="d_pulse">Tętno</label>
          <input id="d_pulse" type="number" min="20" max="220" />
        </div>
        <div>
          <label for="d_pos">Pozycja</label>
          <select id="d_pos">
            <option value="">—</option>
            <option value="siedzaca">Siedząca</option>
            <option value="lezaca">Leżąca</option>
            <option value="stojaca">Stojąca</option>
          </select>
        </div>
      </div>

      <div style="margin-top:6px">
        <label>Kontekst</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
            <input id="d_rested" type="checkbox"> po 5 min odpoczynku
          </label>
          <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
            <input id="d_meds" type="checkbox"> leki wzięte
          </label>
        </div>
      </div>

      <div style="margin-top:6px">
        <label for="d_note">Notatka</label>
        <input id="d_note" type="text" />
      </div>
    </form>
  </div>
  <div class="modalFoot">
    <button id="dlgDelete" type="button" class="danger">Usuń</button>
    <div style="flex:1"></div>
    <button id="dlgCancel" type="button" class="ghost">Anuluj</button>
    <button id="dlgSave" type="button">Zapisz zmiany</button>
  </div>
</dialog>

<script>
const LS_KEY = 'bp_records_v2';

function nowLocalISO(){
  const d = new Date();
  const pad = n=>n.toString().padStart(2,'0');
  return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes());
}
function uid(){
  return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
}
function toLocalInputValue(dateOrString){
  const d = (dateOrString instanceof Date) ? dateOrString : new Date(dateOrString);
  const pad = n=>n.toString().padStart(2,'0');
  return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes());
}
function clampNum(v, min, max){
  const n = Number(v);
  if(!Number.isFinite(n)) return null;
  if(n < min) return null;
  if(n > max) return null;
  return n;
}
function safeStr(x){ return (x ?? '').toString(); }
function normText(s){ return safeStr(s).trim().toLowerCase(); }

const form = document.getElementById('measureForm');
const tsEl = document.getElementById('ts');
const sysEl = document.getElementById('sys');
const diaEl = document.getElementById('dia');
const pulseEl = document.getElementById('pulse');
const noteEl = document.getElementById('note');
const posEl = document.getElementById('pos');
const restedEl = document.getElementById('rested');
const medsEl = document.getElementById('meds');

const clearBtn = document.getElementById('clearBtn');
const exportCsvBtn = document.getElementById('exportCsv');
const importCsvBtn = document.getElementById('importCsvBtn');
const importCsvInput = document.getElementById('importCsv');
const exportJsonBtn = document.getElementById('exportJson');
const importJsonBtn = document.getElementById('importJsonBtn');
const importJsonInput = document.getElementById('importJson');
const resetAllBtn = document.getElementById('resetAll');
const printReportBtn = document.getElementById('printReport');

const listWrap = document.getElementById('listWrap');
const chartCanvas = document.getElementById('chart');
const ctx = chartCanvas.getContext('2d');

const rangeSel = document.getElementById('rangeSel');
const sortSel = document.getElementById('sortSel');
const searchNote = document.getElementById('searchNote');
const countInfo = document.getElementById('countInfo');
const kpiWrap = document.getElementById('kpi');

const toast = document.getElementById('toast');
const reloadBtn = document.getElementById('reloadBtn');
const dismissBtn = document.getElementById('dismissBtn');
const toastTxt = document.getElementById('toastTxt');

const editDlg = document.getElementById('editDlg');
const dlgClose = document.getElementById('dlgClose');
const dlgCancel = document.getElementById('dlgCancel');
const dlgSave = document.getElementById('dlgSave');
const dlgDelete = document.getElementById('dlgDelete');

const d_ts = document.getElementById('d_ts');
const d_sys = document.getElementById('d_sys');
const d_dia = document.getElementById('d_dia');
const d_pulse = document.getElementById('d_pulse');
const d_note = document.getElementById('d_note');
const d_pos = document.getElementById('d_pos');
const d_rested = document.getElementById('d_rested');
const d_meds = document.getElementById('d_meds');

tsEl.value = nowLocalISO();

let currentEditId = null;
let updateWaitingWorker = null;

function loadRecords(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(arr)) return [];
    return arr.map(migrateRecord).filter(Boolean);
  }catch(e){ return []; }
}
function saveRecords(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
}
function sortByTsAsc(arr){
  return arr.slice().sort((a,b)=> new Date(a.ts) - new Date(b.ts));
}
function migrateRecord(r){
  if(!r || typeof r !== 'object') return null;
  const out = {
    id: safeStr(r.id) || uid(),
    ts: safeStr(r.ts) || new Date().toISOString(),
    sys: Number(r.sys),
    dia: Number(r.dia),
    pulse: (r.pulse === null || r.pulse === undefined || r.pulse === '') ? null : Number(r.pulse),
    note: safeStr(r.note || ''),
    pos: safeStr(r.pos || ''),
    rested: !!r.rested,
    meds: !!r.meds
  };
  if(!Number.isFinite(out.sys) || !Number.isFinite(out.dia)) return null;
  if(out.pulse !== null && !Number.isFinite(out.pulse)) out.pulse = null;
  const d = new Date(out.ts);
  if(isNaN(d.getTime())) out.ts = new Date().toISOString();
  return out;
}
function upsertRecord(rec){
  const arr = loadRecords();
  const idx = arr.findIndex(x => x.id === rec.id);
  if(idx >= 0) arr[idx] = rec;
  else arr.push(rec);
  saveRecords(sortByTsAsc(arr));
}
function deleteRecord(id){
  const arr = loadRecords().filter(x => x.id !== id);
  saveRecords(arr);
}
function clearForm(){
  tsEl.value = nowLocalISO();
  sysEl.value = '';
  diaEl.value = '';
  pulseEl.value = '';
  noteEl.value = '';
  posEl.value = '';
  restedEl.checked = false;
  medsEl.checked = false;
}

/* ===== KLASYFIKACJA ESC/ESH (Europa) =====
   Pomiar gabinetowy:
   - Optymalne: <120 i <80
   - Prawidłowe: 120–129 i/lub 80–84
   - Wysokie prawidłowe: 130–139 i/lub 85–89
   - Nadciśnienie: ≥140 i/lub ≥90
   + Alert kryzysowy UI: ≥180 i/lub ≥120
*/
function classifyBP(sys, dia){
  if(sys >= 180 || dia >= 120) return {key:'crisis', label:'B. wysokie', cls:'crisis'};
  if(sys >= 140 || dia >= 90) return {key:'htn', label:'Nadciśnienie', cls:'htn'};
  if((sys >= 130 && sys <= 139) || (dia >= 85 && dia <= 89)) return {key:'hnorm', label:'Wysokie prawidłowe', cls:'hnorm'};
  if((sys >= 120 && sys <= 129) || (dia >= 80 && dia <= 84)) return {key:'norm', label:'Prawidłowe', cls:'norm'};
  if(sys < 120 && dia < 80) return {key:'opt', label:'Optymalne', cls:'opt'};
  // przypadki mieszane (np. SYS <120 ale DIA 80-84) wpadną wyżej dzięki warunkom OR;
  // tu zostaje tylko "inne" (rzadkie) – traktuj jak prawidłowe.
  return {key:'norm', label:'Prawidłowe', cls:'norm'};
}

function posLabel(v){
  if(v==='siedzaca') return 'siedząca';
  if(v==='lezaca') return 'leżąca';
  if(v==='stojaca') return 'stojąca';
  return '';
}

function applyFilters(arr){
  const range = rangeSel.value;
  const q = normText(searchNote.value);

  let out = arr.slice();

  if(range !== 'all'){
    const days = Number(range);
    if(Number.isFinite(days)){
      const from = new Date();
      from.setHours(0,0,0,0);
      from.setDate(from.getDate() - (days - 1));
      out = out.filter(r => new Date(r.ts) >= from);
    }
  }

  if(q){
    out = out.filter(r=>{
      const blob = [
        r.note,
        posLabel(r.pos),
        r.rested ? 'odpoczynek' : '',
        r.meds ? 'leki' : ''
      ].join(' ');
      return normText(blob).includes(q);
    });
  }

  const order = sortSel.value;
  out.sort((a,b)=>{
    const da = new Date(a.ts).getTime();
    const db = new Date(b.ts).getTime();
    return order === 'asc' ? (da - db) : (db - da);
  });

  return out;
}

function fmt2(n){ return Number.isFinite(n) ? Math.round(n) : '—'; }
function avg(nums){
  const v = nums.filter(Number.isFinite);
  if(!v.length) return null;
  return v.reduce((a,b)=>a+b,0)/v.length;
}
function minmax(nums){
  const v = nums.filter(Number.isFinite);
  if(!v.length) return {min:null,max:null};
  return {min:Math.min(...v), max:Math.max(...v)};
}
function daysRangeStats(all, days){
  const from = new Date();
  from.setHours(0,0,0,0);
  from.setDate(from.getDate() - (days - 1));
  const part = all.filter(r=> new Date(r.ts) >= from);
  const sys = part.map(r=>r.sys);
  const dia = part.map(r=>r.dia);
  const pulse = part.map(r=>r.pulse ?? null);

  return {
    count: part.length,
    sysAvg: avg(sys),
    diaAvg: avg(dia),
    pulseAvg: avg(pulse),
    sysMM: minmax(sys),
    diaMM: minmax(dia),
    pulseMM: minmax(pulse)
  };
}
function trendArrow(a, b){
  if(a === null || b === null) return '—';
  const diff = a - b;
  if(Math.abs(diff) < 0.5) return '→';
  return diff > 0 ? '↑' : '↓';
}

function renderKPI(all){
  const s7 = daysRangeStats(all, 7);
  const s30 = daysRangeStats(all, 30);

  const sysArrow = trendArrow(s7.sysAvg, s30.sysAvg);
  const diaArrow = trendArrow(s7.diaAvg, s30.diaAvg);

  const blocks = [
    {
      val: `${fmt2(s7.sysAvg)}/${fmt2(s7.diaAvg)} ${sysArrow}${diaArrow}`,
      lbl: `Średnia 7 dni (SYS/DIA) • pomiarów: ${s7.count}`
    },
    {
      val: `${fmt2(s30.sysAvg)}/${fmt2(s30.diaAvg)}`,
      lbl: `Średnia 30 dni (SYS/DIA) • pomiarów: ${s30.count}`
    },
    {
      val: `${fmt2(s30.sysMM.min)}–${fmt2(s30.sysMM.max)} / ${fmt2(s30.diaMM.min)}–${fmt2(s30.diaMM.max)}`,
      lbl: `Min–max 30 dni (SYS / DIA)`
    },
    {
      val: `${fmt2(s30.pulseAvg)}`,
      lbl: `Średnie tętno 30 dni (bpm)`
    }
  ];

  kpiWrap.innerHTML = blocks.map(b => `
    <div class="box">
      <div class="val">${b.val}</div>
      <div class="lbl">${b.lbl}</div>
    </div>
  `).join('');
}

function renderList(){
  const allAsc = sortByTsAsc(loadRecords());
  const view = applyFilters(allAsc);

  countInfo.textContent = `Wyświetlone: ${view.length} • Wszystkie: ${allAsc.length}`;
  renderKPI(allAsc);

  if(view.length===0){
    listWrap.innerHTML = '<div class="small">Brak wyników dla wybranego filtra.</div>';
    renderChart();
    return;
  }

  let html = '<table><thead><tr>' +
    '<th>Data</th><th>SYS</th><th>DIA</th><th>Tętno</th><th>Status</th><th>Kontekst</th><th>Notatka</th><th></th>' +
    '</tr></thead><tbody>';

  view.forEach((it)=>{
    const cls = classifyBP(it.sys, it.dia);
    const ctxParts = [];
    if(it.pos) ctxParts.push(posLabel(it.pos));
    if(it.rested) ctxParts.push('odpoczynek');
    if(it.meds) ctxParts.push('leki');
    const ctxText = ctxParts.join(', ');

    html += `<tr data-id="${it.id}">
      <td>${new Date(it.ts).toLocaleString()}</td>
      <td>${it.sys}</td>
      <td>${it.dia}</td>
      <td>${it.pulse ?? ''}</td>
      <td><span class="pill ${cls.cls}">${cls.label}</span></td>
      <td class="small">${ctxText}</td>
      <td>${(it.note||'').slice(0,80)}</td>
      <td><button class="ghost" data-edit="${it.id}" type="button">Edytuj</button></td>
    </tr>`;
  });

  html += '</tbody></table>';
  listWrap.innerHTML = html;

  renderChart();
}

/* ===== WYKRES (ostatnie 30) ===== */
function resizeCanvasToDisplaySize(canvas){
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const w = Math.max(1, Math.round(rect.width * dpr));
  const h = Math.max(1, Math.round(rect.height * dpr));
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w;
    canvas.height = h;
  }
  return {w, h};
}
function drawLine(points, x0, y0, w, h, yMin, yMax, getY, dashed=false){
  if(points.length < 2) return;
  ctx.save();
  ctx.lineWidth = 2;
  if(dashed) ctx.setLineDash([6,6]);
  ctx.beginPath();
  for(let i=0;i<points.length;i++){
    const x = x0 + (i/(points.length-1))*w;
    const yVal = getY(points[i]);
    const y = y0 + h - ((yVal - yMin)/(yMax - yMin))*h;
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.restore();
}
function renderChart(){
  const all = sortByTsAsc(loadRecords());
  const points = all.slice(-30);
  const {w, h} = resizeCanvasToDisplaySize(chartCanvas);

  ctx.clearRect(0,0,w,h);

  const pad = 22;
  const x0 = pad*2;
  const y0 = pad;
  const plotW = w - x0 - pad;
  const plotH = h - y0 - pad*1.8;

  ctx.save();
  ctx.globalAlpha = 0.95;
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,w,h);
  ctx.restore();

  if(points.length === 0){
    ctx.save();
    ctx.fillStyle = '#6b7280';
    ctx.font = '14px system-ui';
    ctx.fillText('Brak danych do wykresu.', x0, y0 + 20);
    ctx.restore();
    return;
  }

  const sysVals = points.map(p=>p.sys).filter(Number.isFinite);
  const diaVals = points.map(p=>p.dia).filter(Number.isFinite);
  const pulseVals = points.map(p=>p.pulse).filter(Number.isFinite);

  let yMin = Math.min(...sysVals, ...diaVals);
  let yMax = Math.max(...sysVals, ...diaVals);
  yMin = Math.floor((yMin - 10)/10)*10;
  yMax = Math.ceil((yMax + 10)/10)*10;

  ctx.save();
  ctx.strokeStyle = '#eef2f7';
  ctx.fillStyle = '#6b7280';
  ctx.font = '12px system-ui';
  const ticks = 5;
  for(let t=0;t<=ticks;t++){
    const yy = y0 + plotH - (t/ticks)*plotH;
    ctx.beginPath();
    ctx.moveTo(x0, yy);
    ctx.lineTo(x0+plotW, yy);
    ctx.stroke();
    const val = yMin + (t/ticks)*(yMax - yMin);
    ctx.fillText(String(Math.round(val)), pad, yy+4);
  }
  ctx.restore();

  ctx.save();
  ctx.strokeStyle = '#e6e9ef';
  ctx.beginPath();
  ctx.moveTo(x0, y0);
  ctx.lineTo(x0, y0+plotH);
  ctx.lineTo(x0+plotW, y0+plotH);
  ctx.stroke();
  ctx.restore();

  ctx.save();
  ctx.strokeStyle = '#0b6cf0';
  drawLine(points, x0, y0, plotW, plotH, yMin, yMax, p=>p.sys, false);
  ctx.restore();

  ctx.save();
  ctx.strokeStyle = '#10b981';
  drawLine(points, x0, y0, plotW, plotH, yMin, yMax, p=>p.dia, false);
  ctx.restore();

  if(pulseVals.length >= 2){
    const pMin = Math.min(...pulseVals);
    const pMax = Math.max(...pulseVals);
    if(pMax > pMin){
      ctx.save();
      ctx.strokeStyle = '#f59e0b';
      drawLine(points, x0, y0, plotW, plotH, yMin, yMax, p=>{
        if(!Number.isFinite(p.pulse)) return yMin;
        const k = (p.pulse - pMin)/(pMax - pMin);
        return yMin + k*(yMax - yMin);
      }, true);
      ctx.restore();
    }
  }
}

window.addEventListener('resize', ()=>renderChart());

/* ===== CSV ===== */
function csvEscape(v){
  const s = (v ?? '').toString();
  if(/[",\n;]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function downloadFile(name, text, mime='text/plain'){
  const blob = new Blob([text], {type: mime});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
}
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = '';
  let inQ = false;

  for(let i=0;i<text.length;i++){
    const ch = text[i];
    const nxt = text[i+1];

    if(inQ){
      if(ch === '"' && nxt === '"'){ cur += '"'; i++; continue; }
      if(ch === '"'){ inQ = false; continue; }
      cur += ch;
    }else{
      if(ch === '"'){ inQ = true; continue; }
      if(ch === ','){ row.push(cur); cur=''; continue; }
      if(ch === '\n' || ch === '\r'){
        if(ch === '\r' && nxt === '\n') i++;
        row.push(cur); cur='';
        if(row.length>1 || row[0]!=='' ) rows.push(row);
        row = [];
        continue;
      }
      cur += ch;
    }
  }
  row.push(cur);
  if(row.length>1 || row[0]!=='' ) rows.push(row);
  return rows;
}

/* ===== JSON BACKUP ===== */
function exportJSON(){
  const payload = {
    app: 'bp-pwa',
    version: 2,
    exported_at: new Date().toISOString(),
    records: sortByTsAsc(loadRecords())
  };
  const stamp = new Date().toISOString().slice(0,10);
  downloadFile(`cisnienie_backup_${stamp}.json`, JSON.stringify(payload, null, 2), 'application/json;charset=utf-8');
}
function importJSON(text){
  let obj = null;
  try{ obj = JSON.parse(text); }catch(e){ obj = null; }
  if(!obj) { alert('Nieprawidłowy plik JSON.'); return; }

  let recs = null;
  if(Array.isArray(obj)) recs = obj;
  else if(Array.isArray(obj.records)) recs = obj.records;
  else recs = null;

  if(!recs) { alert('JSON nie zawiera listy rekordów.'); return; }

  const imported = recs.map(migrateRecord).filter(Boolean).map(r=>({ ...r, id: r.id || uid() }));
  if(!imported.length){ alert('Brak poprawnych rekordów w pliku.'); return; }

  const merged = sortByTsAsc(loadRecords().concat(imported));
  saveRecords(merged);
  renderList();
  alert(`Przywrócono / dodano rekordów: ${imported.length}.`);
}

/* ===== MODAL EDYCJI ===== */
function openEdit(id){
  const rec = loadRecords().find(x=>x.id === id);
  if(!rec) return;
  currentEditId = rec.id;

  d_ts.value = toLocalInputValue(rec.ts);
  d_sys.value = rec.sys;
  d_dia.value = rec.dia;
  d_pulse.value = rec.pulse ?? '';
  d_note.value = rec.note ?? '';
  d_pos.value = rec.pos ?? '';
  d_rested.checked = !!rec.rested;
  d_meds.checked = !!rec.meds;

  if(typeof editDlg.showModal === 'function') editDlg.showModal();
  else editDlg.setAttribute('open','open');
}
function closeEdit(){
  currentEditId = null;
  if(typeof editDlg.close === 'function') editDlg.close();
  else editDlg.removeAttribute('open');
}
function saveEdit(){
  if(!currentEditId) return;

  const ts = d_ts.value ? new Date(d_ts.value).toISOString() : null;
  const sys = clampNum(d_sys.value, 40, 300);
  const dia = clampNum(d_dia.value, 30, 200);
  const pulseRaw = safeStr(d_pulse.value).trim();
  const pulse = pulseRaw ? clampNum(pulseRaw, 20, 220) : null;
  const note = safeStr(d_note.value).trim();
  const pos = safeStr(d_pos.value);
  const rested = !!d_rested.checked;
  const meds = !!d_meds.checked;

  if(!ts || sys === null || dia === null){
    alert('Uzupełnij poprawnie datę oraz wartości SYS/DIA.');
    return;
  }

  const rec = {
    id: currentEditId,
    ts, sys, dia, pulse, note, pos, rested, meds
  };

  upsertRecord(rec);
  closeEdit();
  renderList();
}

/* ===== RAPORT / DRUK ===== */
function makeReportHTML(records){
  const allAsc = sortByTsAsc(records);
  const s7 = daysRangeStats(allAsc, 7);
  const s30 = daysRangeStats(allAsc, 30);

  const rows = allAsc.slice().reverse().map(r=>{
    const c = classifyBP(r.sys, r.dia);
    const ctxParts = [];
    if(r.pos) ctxParts.push(posLabel(r.pos));
    if(r.rested) ctxParts.push('odpoczynek');
    if(r.meds) ctxParts.push('leki');
    const ctxText = ctxParts.join(', ');
    return `
      <tr>
        <td>${new Date(r.ts).toLocaleString()}</td>
        <td>${r.sys}</td>
        <td>${r.dia}</td>
        <td>${r.pulse ?? ''}</td>
        <td>${c.label}</td>
        <td>${ctxText}</td>
        <td>${(r.note||'').replace(/</g,'&lt;')}</td>
      </tr>
    `;
  }).join('');

  const style = `
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px;color:#111}
      h1{margin:0 0 6px 0;font-size:18px}
      .sub{color:#555;margin:0 0 16px 0;font-size:12px}
      .k{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:12px 0 16px 0}
      .box{border:1px solid #ddd;border-radius:10px;padding:10px}
      .val{font-weight:800;font-size:14px}
      .lbl{color:#666;font-size:11px;margin-top:4px}
      table{width:100%;border-collapse:collapse;font-size:12px}
      th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
      th{background:#fafafa}
      @media print{
        button{display:none}
        body{margin:0}
      }
    </style>
  `;

  const kpi = `
    <div class="k">
      <div class="box"><div class="val">${fmt2(s7.sysAvg)}/${fmt2(s7.diaAvg)}</div><div class="lbl">Średnia 7 dni • pomiarów: ${s7.count}</div></div>
      <div class="box"><div class="val">${fmt2(s30.sysAvg)}/${fmt2(s30.diaAvg)}</div><div class="lbl">Średnia 30 dni • pomiarów: ${s30.count}</div></div>
      <div class="box"><div class="val">${fmt2(s30.sysMM.min)}–${fmt2(s30.sysMM.max)} / ${fmt2(s30.diaMM.min)}–${fmt2(s30.diaMM.max)}</div><div class="lbl">Min–max 30 dni (SYS/DIA)</div></div>
    </div>
  `;

  return `
    <!doctype html><html lang="pl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Raport ciśnienia</title>${style}</head><body>
    <button onclick="window.print()">Drukuj</button>
    <h1>Raport pomiarów ciśnienia</h1>
    <p class="sub">Wygenerowano: ${new Date().toLocaleString()} • Rekordów: ${allAsc.length}</p>
    ${kpi}
    <table>
      <thead>
        <tr><th>Data</th><th>SYS</th><th>DIA</th><th>Tętno</th><th>Status</th><th>Kontekst</th><th>Notatka</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    </body></html>
  `;
}
function openReport(){
  const records = loadRecords();
  const html = makeReportHTML(records);
  const w = window.open('', '_blank');
  if(!w){ alert('Zablokowane okno. Zezwól na pop-upy, aby otworzyć raport.'); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* ===== ZDARZENIA ===== */
form.addEventListener('submit', (e)=>{
  e.preventDefault();

  const ts = tsEl.value ? new Date(tsEl.value).toISOString() : null;
  const sys = clampNum(sysEl.value, 40, 300);
  const dia = clampNum(diaEl.value, 30, 200);
  const pulseRaw = safeStr(pulseEl.value).trim();
  const pulse = pulseRaw ? clampNum(pulseRaw, 20, 220) : null;
  const note = safeStr(noteEl.value).trim();
  const pos = safeStr(posEl.value);
  const rested = !!restedEl.checked;
  const meds = !!medsEl.checked;

  if(!ts || sys === null || dia === null){
    alert('Uzupełnij poprawnie datę oraz wartości SYS/DIA.');
    return;
  }

  const rec = { id: uid(), ts, sys, dia, pulse, note, pos, rested, meds };
  upsertRecord(rec);
  clearForm();
  renderList();
});

clearBtn.addEventListener('click', ()=> clearForm());

listWrap.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const editId = btn.getAttribute('data-edit');
  if(editId) openEdit(editId);
});

dlgClose.addEventListener('click', closeEdit);
dlgCancel.addEventListener('click', closeEdit);
dlgSave.addEventListener('click', saveEdit);
dlgDelete.addEventListener('click', ()=>{
  if(!currentEditId) return;
  if(confirm('Usunąć ten pomiar?')){
    deleteRecord(currentEditId);
    closeEdit();
    renderList();
  }
});

resetAllBtn.addEventListener('click', ()=>{
  if(confirm('Na pewno usunąć WSZYSTKIE pomiary?')){
    saveRecords([]);
    clearForm();
    renderList();
  }
});

rangeSel.addEventListener('change', renderList);
sortSel.addEventListener('change', renderList);
searchNote.addEventListener('input', ()=>{ renderList(); });

exportCsvBtn.addEventListener('click', ()=>{
  const arr = sortByTsAsc(loadRecords());
  const header = ['ts','sys','dia','pulse','note','pos','rested','meds'];
  const lines = [header.join(',')];
  arr.forEach(r=>{
    lines.push([
      csvEscape(r.ts),
      csvEscape(r.sys),
      csvEscape(r.dia),
      csvEscape(r.pulse ?? ''),
      csvEscape(r.note ?? ''),
      csvEscape(r.pos ?? ''),
      csvEscape(r.rested ? '1' : '0'),
      csvEscape(r.meds ? '1' : '0')
    ].join(','));
  });
  const stamp = new Date().toISOString().slice(0,10);
  downloadFile(`cisnienie_${stamp}.csv`, lines.join('\n'), 'text/csv;charset=utf-8');
});

importCsvBtn.addEventListener('click', ()=>{
  importCsvInput.value = '';
  importCsvInput.click();
});

importCsvInput.addEventListener('change', async ()=>{
  const file = importCsvInput.files && importCsvInput.files[0];
  if(!file) return;

  const text = await file.text();
  const rows = parseCSV(text.trim());
  if(rows.length < 2){
    alert('CSV wygląda na pusty.');
    return;
  }

  const header = rows[0].map(h=>h.trim().toLowerCase());
  const idx = (name)=> header.indexOf(name);

  const iTs = idx('ts');
  const iSys = idx('sys');
  const iDia = idx('dia');
  const iPulse = idx('pulse');
  const iNote = idx('note');
  const iPos = idx('pos');
  const iRested = idx('rested');
  const iMeds = idx('meds');

  if(iTs < 0 || iSys < 0 || iDia < 0){
    alert('CSV musi mieć kolumny: ts, sys, dia (opcjonalnie: pulse, note, pos, rested, meds).');
    return;
  }

  const imported = [];
  for(let r=1;r<rows.length;r++){
    const line = rows[r];
    const tsRaw = safeStr(line[iTs]).trim();
    const sysRaw = safeStr(line[iSys]).trim();
    const diaRaw = safeStr(line[iDia]).trim();
    const pulseRaw = iPulse>=0 ? safeStr(line[iPulse]).trim() : '';
    const noteRaw = iNote>=0 ? safeStr(line[iNote]).trim() : '';
    const posRaw = iPos>=0 ? safeStr(line[iPos]).trim() : '';
    const restedRaw = iRested>=0 ? safeStr(line[iRested]).trim() : '';
    const medsRaw = iMeds>=0 ? safeStr(line[iMeds]).trim() : '';

    const tsDate = new Date(tsRaw);
    if(!tsRaw || isNaN(tsDate.getTime())) continue;

    const sys = clampNum(sysRaw, 40, 300);
    const dia = clampNum(diaRaw, 30, 200);
    const pulse = pulseRaw ? clampNum(pulseRaw, 20, 220) : null;
    if(sys===null || dia===null) continue;

    imported.push({
      id: uid(),
      ts: tsDate.toISOString(),
      sys, dia, pulse,
      note: noteRaw,
      pos: posRaw,
      rested: restedRaw === '1' || restedRaw.toLowerCase()==='true' || restedRaw.toLowerCase()==='tak',
      meds: medsRaw === '1' || medsRaw.toLowerCase()==='true' || medsRaw.toLowerCase()==='tak'
    });
  }

  if(imported.length === 0){
    alert('Nie udało się zaimportować żadnego poprawnego wiersza.');
    return;
  }

  const merged = sortByTsAsc(loadRecords().concat(imported.map(migrateRecord).filter(Boolean)));
  saveRecords(merged);
  renderList();
  alert(`Zaimportowano: ${imported.length} pomiarów.`);
});

exportJsonBtn.addEventListener('click', exportJSON);

importJsonBtn.addEventListener('click', ()=>{
  importJsonInput.value = '';
  importJsonInput.click();
});
importJsonInput.addEventListener('change', async ()=>{
  const file = importJsonInput.files && importJsonInput.files[0];
  if(!file) return;
  const text = await file.text();
  importJSON(text);
});

printReportBtn.addEventListener('click', openReport);

/* ===== SW UPDATE UI ===== */
function showToast(msg){
  toastTxt.textContent = msg || 'Nowa wersja aplikacji jest dostępna.';
  toast.style.display = 'flex';
}
function hideToast(){
  toast.style.display = 'none';
}
dismissBtn.addEventListener('click', hideToast);

reloadBtn.addEventListener('click', ()=>{
  hideToast();
  if(updateWaitingWorker){
    updateWaitingWorker.postMessage({type:'SKIP_WAITING'});
  }
  window.location.reload();
});

/* START */
renderList();

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then((reg)=>{
    function listenForWaitingWorker(r){
      if(!r) return;
      if(r.waiting){
        updateWaitingWorker = r.waiting;
        showToast('Nowa wersja aplikacji jest dostępna.');
      }
      r.addEventListener('updatefound', ()=>{
        const nw = r.installing;
        if(!nw) return;
        nw.addEventListener('statechange', ()=>{
          if(nw.state === 'installed' && navigator.serviceWorker.controller){
            updateWaitingWorker = r.waiting;
            showToast('Nowa wersja aplikacji jest dostępna.');
          }
        });
      });
    }
    listenForWaitingWorker(reg);
  }).catch(()=>{});
}
</script>
</body>
</html>
