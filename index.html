<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Miernik ciśnienia — PWA</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0b6cf0" />

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Miernik Ciśn.">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<link rel="icon" href="icons/apple-touch-icon-180.png">
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon-180.png">
<link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">

<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --accent:#0b6cf0; --muted:#6b7280;
    --ok:#10b981; --ok2:#22c55e; --warn:#f59e0b; --bad:#ef4444; --crisis:#b91c1c;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:18px auto;padding:14px}
  header{display:flex;align-items:center;gap:12px;position:relative}
  header h1{font-size:1.1rem;margin:0}
  .brandIcon{
    position:fixed;left:12px;top:12px;z-index:10000;
    width:34px;height:34px;border-radius:10px;
    background:#fff;border:1px solid #eef2f7;
    box-shadow:0 6px 18px rgba(16,24,40,.12);
    display:flex;align-items:center;justify-content:center;
    overflow:hidden;
  }
  .brandIcon img{width:22px;height:22px;display:block}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 1px 6px rgba(16,24,40,.06);margin-top:12px}
  form .row{display:flex;gap:8px;align-items:flex-end;margin-bottom:8px;flex-wrap:wrap}
  input[type=number],input[type=datetime-local],input[type=text],textarea,select{
    padding:8px;border-radius:8px;border:1px solid #e6e9ef;background:white
  }
  input[type=text],textarea,select{min-width:220px}
  input[type=number]{width:120px}
  input[type=datetime-local]{min-width:220px}
  label{font-size:0.85rem;color:var(--muted);display:block;margin-bottom:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
  button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #e6e9ef}
  button.danger{background:transparent;color:var(--bad);border:1px solid #fee2e2}
  .list{margin-top:12px}
  table{width:100%;border-collapse:collapse;font-size:0.95rem}
  th,td{padding:8px;border-bottom:1px solid #f1f3f7;text-align:left;vertical-align:top}
  th{white-space:nowrap}
  .small{font-size:0.85rem;color:var(--muted)}
  .chartwrap{margin-top:12px;padding:8px}
  canvas{width:100%;height:220px;border-radius:8px;background:linear-gradient(180deg,#fff, #fbfdff)}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:0.78rem;font-weight:800;border:1px solid #e6e9ef}
  .pill.opt{color:var(--ok);border-color:#d1fae5;background:#ecfdf5}
  .pill.norm{color:var(--ok2);border-color:#dcfce7;background:#f0fdf4}
  .pill.hnorm{color:var(--warn);border-color:#fde68a;background:#fffbeb}
  .pill.htn{color:var(--bad);border-color:#fecaca;background:#fef2f2}
  .pill.crisis{color:var(--crisis);border-color:#fecaca;background:#fee2e2}
  .pill.good{color:#2563eb;border-color:#bfdbfe;background:#eff6ff}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:10px}
  .kpi .box{border:1px solid #eef2f7;border-radius:12px;padding:10px}
  .kpi .val{font-weight:800;font-size:1.05rem}
  .kpi .lbl{font-size:0.78rem;color:var(--muted);margin-top:4px}
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;margin-top:10px}
  .filters .f{display:flex;flex-direction:column}
  .toast{
    position:fixed;left:12px;right:12px;bottom:12px;
    background:#111;color:#fff;border-radius:12px;padding:10px 12px;
    box-shadow:0 8px 30px rgba(0,0,0,.18);
    display:none;align-items:center;gap:10px;z-index:9999;
    max-width:980px;margin:0 auto;
  }
  .toast .txt{flex:1;font-size:0.95rem}
  .toast button{background:#fff;color:#111;border:0}
  dialog{
    border:0;border-radius:14px;max-width:820px;width:calc(100% - 28px);
    padding:0;box-shadow:0 16px 60px rgba(0,0,0,.25);
  }
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .modalHead{padding:12px 12px 0 12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .modalBody{padding:12px}
  .modalFoot{padding:0 12px 12px 12px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .xbtn{background:transparent;border:1px solid #e6e9ef;color:#111}
  .muted{color:var(--muted)}
  .hint{font-size:0.82rem;color:var(--muted);margin-top:6px}
  @media(max-width:820px){
    .kpi{grid-template-columns:repeat(2,minmax(0,1fr))}
  }

  @media (max-width: 640px){
    input[type=text], textarea, select, input[type=datetime-local]{
      min-width: 0 !important;
      width: 100%;
      box-sizing: border-box;
    }
    form .row > div{
      min-width: 0 !important;
      width: 100% !important;
      flex: 1 1 100%;
    }
    #measureForm .row label{
      max-width: 100%;
    }
  }

  html, body { overflow-x: hidden; }
  .list { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .list table { min-width: 920px; }

  input, select, textarea, button { font-size: 16px !important; }
  #measureForm label, #dlgForm label { font-size: 14px; }
</style>
</head>
<body>

<div class="wrap">
  <header>
    <img src="icons/favicon.png" width="42" height="42" alt="logo">
    <div>
      <h1>Miernik ciśnienia — PWA</h1>
      <div class="small">Szybki zapis pomiarów ciśnienia i tętna. Działa offline.</div>
    </div>
  </header>

  <div class="card" id="entryCard">
    <form id="measureForm">
      <div class="row">
        <div>
          <label for="ts">Data i godzina</label>
          <input id="ts" type="datetime-local" required />
        </div>
        <div>
          <label for="sys">Skurczowe (mmHg)</label>
          <input id="sys" type="number" min="40" max="300" required inputmode="numeric" />
        </div>
        <div>
          <label for="dia">Rozkurczowe (mmHg)</label>
          <input id="dia" type="number" min="30" max="200" required inputmode="numeric" />
        </div>
        <div>
          <label for="pulse">Tętno (bpm)</label>
          <input id="pulse" type="number" min="20" max="220" inputmode="numeric" />
        </div>
        <div>
          <label for="mtype">Typ pomiaru</label>
          <select id="mtype">
            <option value="domowy" selected>Domowy</option>
            <option value="gabinetowy">Gabinetowy</option>
          </select>
        </div>
        <div>
          <label for="pos">Pozycja</label>
          <select id="pos">
            <option value="">—</option>
            <option value="siedzaca">Siedząca</option>
            <option value="lezaca">Leżąca</option>
            <option value="stojaca">Stojąca</option>
          </select>
        </div>
        <div>
          <label>Kontekst</label>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
              <input id="rested" type="checkbox"> po 5 min odpoczynku
            </label>
            <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
              <input id="meds" type="checkbox"> leki wzięte
            </label>
            <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
              <input id="valid" type="checkbox" checked> pomiar poprawny
            </label>
          </div>
        </div>
      </div>

      <div style="margin-top:6px">
        <label for="note">Notatka (np. leki, objawy)</label>
        <input id="note" type="text" placeholder="np. po spacerze, ból głowy, amlodypina" />
        <div class="hint">Tip: „pomiar poprawny” odznacz, jeśli np. kawa, stres, brak odpoczynku, zły mankiet.</div>
      </div>

      <div class="controls">
        <button id="saveBtn" type="submit">Zapisz pomiar</button>
        <button id="copyLast" type="button" class="ghost">Skopiuj ostatni kontekst</button>
        <button id="clearBtn" type="button" class="ghost">Wyczyść formularz</button>

        <div style="flex:1"></div>
        <div class="actions">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
            <div>
              <label for="docFrom">Lekarz: od</label>
              <input id="docFrom" type="date" />
            </div>
            <div>
              <label for="docTo">do</label>
              <input id="docTo" type="date" />
            </div>
            <div>
              <label for="docOnlyValid">Tylko poprawne</label>
              <select id="docOnlyValid">
                <option value="yes" selected>Tak</option>
                <option value="all">Nie</option>
              </select>
            </div>
          </div>

          <button id="exportCsv" type="button" class="ghost">Eksport CSV</button>
          <button id="importCsvBtn" type="button" class="ghost">Import CSV</button>
          <input id="importCsv" type="file" accept=".csv" style="display:none" />
          <button id="exportJson" type="button" class="ghost">Kopia JSON</button>
          <button id="importJsonBtn" type="button" class="ghost">Przywróć JSON</button>
          <input id="importJson" type="file" accept=".json" style="display:none" />
          <button id="printReport" type="button" class="ghost">Raport / druk</button>
          <button id="printDoctor" type="button" class="ghost">Raport dla lekarza</button>
          <button id="resetAll" type="button" class="danger">Usuń wszystkie</button>
        </div>
      </div>
    </form>
  </div>

  <div class="card">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <strong>Historia pomiarów</strong>
        <div class="small">Edytuj w oknie dialogowym • Filtruj • Szukaj w notatkach</div>
      </div>
      <div class="small muted" id="countInfo"></div>
    </div>

    <div class="kpi" id="kpi"></div>

    <div class="filters">
      <div class="f">
        <label for="rangeSel">Zakres</label>
        <select id="rangeSel">
          <option value="all">Wszystkie</option>
          <option value="7">Ostatnie 7 dni</option>
          <option value="30" selected>Ostatnie 30 dni</option>
          <option value="90">Ostatnie 90 dni</option>
        </select>
      </div>
      <div class="f">
        <label for="sortSel">Sortowanie</label>
        <select id="sortSel">
          <option value="desc" selected>Najnowsze → najstarsze</option>
          <option value="asc">Najstarsze → najnowsze</option>
        </select>
      </div>
      <div class="f">
        <label for="onlyValid">Tylko poprawne</label>
        <select id="onlyValid">
          <option value="all" selected>Wszystkie</option>
          <option value="yes">Tylko „poprawne”</option>
        </select>
      </div>
      <div class="f" style="flex:1;min-width:240px">
        <label for="searchNote">Szukaj (notatka/kontekst)</label>
        <input id="searchNote" type="text" placeholder="np. amlodypina, spacer, ból" />
      </div>
    </div>

    <div class="list" id="listWrap"></div>
  </div>

  <div class="card chartwrap">
    <strong>Wykres (ostatnie 30 pomiarów)</strong>
    <canvas id="chart"></canvas>
    <div class="small" style="margin-top:6px">Status wg ESC/ESH (Europa): optymalne, prawidłowe, wysokie prawidłowe, nadciśnienie (+ alert ≥180/120). Linie referencyjne: SYS 140, DIA 90.</div>
  </div>

  <footer style="margin-top:12px;text-align:center" class="small card">
    Dane przechowywane lokalnie w urządzeniu. Działa offline.
  </footer>
</div>

<div class="toast" id="toast">
  <div class="txt" id="toastTxt">Nowa wersja aplikacji jest dostępna.</div>
  <button id="reloadBtn" type="button">Odśwież</button>
  <button id="dismissBtn" type="button" class="ghost" style="border:1px solid rgba(255,255,255,.25);color:#fff;background:transparent">Później</button>
</div>

<dialog id="editDlg">
  <div class="modalHead">
    <div>
      <strong id="dlgTitle">Edytuj pomiar</strong>
      <div class="small muted" id="dlgSub">Zmień dane i zapisz.</div>
    </div>
    <button class="xbtn" id="dlgClose" type="button">Zamknij</button>
  </div>
  <div class="modalBody">
    <form id="dlgForm">
      <div class="row">
        <div>
          <label for="d_ts">Data i godzina</label>
          <input id="d_ts" type="datetime-local" required />
        </div>
        <div>
          <label for="d_sys">Skurczowe</label>
          <input id="d_sys" type="number" min="40" max="300" required inputmode="numeric" />
        </div>
        <div>
          <label for="d_dia">Rozkurczowe</label>
          <input id="d_dia" type="number" min="30" max="200" required inputmode="numeric" />
        </div>
        <div>
          <label for="d_pulse">Tętno</label>
          <input id="d_pulse" type="number" min="20" max="220" inputmode="numeric" />
        </div>
        <div>
          <label for="d_mtype">Typ</label>
          <select id="d_mtype">
            <option value="domowy">Domowy</option>
            <option value="gabinetowy">Gabinetowy</option>
          </select>
        </div>
        <div>
          <label for="d_pos">Pozycja</label>
          <select id="d_pos">
            <option value="">—</option>
            <option value="siedzaca">Siedząca</option>
            <option value="lezaca">Leżąca</option>
            <option value="stojaca">Stojąca</option>
          </select>
        </div>
      </div>

      <div style="margin-top:6px">
        <label>Kontekst</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
            <input id="d_rested" type="checkbox"> po 5 min odpoczynku
          </label>
          <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
            <input id="d_meds" type="checkbox"> leki wzięte
          </label>
          <label style="display:flex;gap:8px;align-items:center;margin:0;color:#111;font-size:0.9rem">
            <input id="d_valid" type="checkbox"> pomiar poprawny
          </label>
        </div>
      </div>

      <div style="margin-top:6px">
        <label for="d_note">Notatka</label>
        <input id="d_note" type="text" />
      </div>
    </form>
  </div>
  <div class="modalFoot">
    <button id="dlgDelete" type="button" class="danger">Usuń</button>
    <div style="flex:1"></div>
    <button id="dlgCancel" type="button" class="ghost">Anuluj</button>
    <button id="dlgSave" type="button">Zapisz zmiany</button>
  </div>
</dialog>

<script>
const LS_KEY = 'bp_records_v4';

function nowLocalISO(){
  const d = new Date();
  const pad = n=>n.toString().padStart(2,'0');
  return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes());
}
function uid(){
  return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
}
function safeStr(x){ return (x ?? '').toString(); }
function normText(s){ return safeStr(s).trim().toLowerCase(); }

function bpStatus(sys, dia){
  if (sys >= 180 || dia >= 120) return { key:'crisis', label:'ALERT ≥180/120' };
  if (sys >= 140 || dia >= 90)  return { key:'htn',    label:'Nadciśnienie' };
  if (sys >= 130 || dia >= 85)  return { key:'hnorm',  label:'Wysokie prawidłowe' };
  if (sys >= 120 || dia >= 80)  return { key:'norm',   label:'Prawidłowe' };
  return { key:'opt', label:'Optymalne' };
}

function fmtDT(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString('pl-PL', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
  }catch{
    return safeStr(iso);
  }
}

function loadRecords(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    console.error("LS parse error", e);
    return [];
  }
}
function saveRecords(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
}

function downloadFile(filename, text, mime){
  const blob = new Blob([text], {type: mime || 'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

function drawChart(records){
  const canvas = document.getElementById('chart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  if(!ctx) return;

  const pts = [...records]
    .filter(r => typeof r.sys === 'number' && typeof r.dia === 'number')
    .sort((a,b)=> (a.ts||'').localeCompare(b.ts||''))
    .slice(-30);

  const dpr = window.devicePixelRatio || 1;
  const cssW = canvas.clientWidth || 900;
  const cssH = canvas.clientHeight || 220;
  canvas.width = Math.round(cssW * dpr);
  canvas.height = Math.round(cssH * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,cssW,cssH);

  const padL=38, padR=10, padT=14, padB=22;
  const W = cssW - padL - padR;
  const H = cssH - padT - padB;

  if(pts.length === 0){
    ctx.fillStyle = 'rgba(17,24,39,.55)';
    ctx.font = '14px system-ui';
    ctx.fillText('Brak danych do wykresu', padL, padT+20);
    return;
  }

  const allY = pts.flatMap(p => [p.sys, p.dia]);
  const minY = Math.max(30, Math.min(...allY) - 10);
  const maxY = Math.min(260, Math.max(...allY) + 10);

  const xAt = i => padL + (pts.length <= 1 ? 0 : (i/(pts.length-1))*W);
  const yAt = v => padT + (1 - (v - minY) / (maxY - minY)) * H;

  // grid + labels
  ctx.lineWidth = 1;
  ctx.strokeStyle = 'rgba(17,24,39,.10)';
  ctx.fillStyle = 'rgba(17,24,39,.55)';
  ctx.font = '12px system-ui';

  const ticks = 4;
  for(let t=0;t<=ticks;t++){
    const v = minY + (t/ticks)*(maxY-minY);
    const y = yAt(v);
    ctx.beginPath();
    ctx.moveTo(padL, y);
    ctx.lineTo(padL+W, y);
    ctx.stroke();
    ctx.fillText(String(Math.round(v)), 6, y+4);
  }

  // ref lines 140/90
  function refLine(val, label){
    if(val < minY || val > maxY) return;
    const y = yAt(val);
    ctx.setLineDash([5,4]);
    ctx.strokeStyle = 'rgba(11,108,240,.35)';
    ctx.beginPath();
    ctx.moveTo(padL, y);
    ctx.lineTo(padL+W, y);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(11,108,240,.75)';
    ctx.fillText(label, padL+6, y-6);
    ctx.fillStyle = 'rgba(17,24,39,.55)';
    ctx.strokeStyle = 'rgba(17,24,39,.10)';
  }
  refLine(140, 'SYS 140');
  refLine(90,  'DIA 90');

  function plotLine(values, stroke){
    ctx.lineWidth = 2;
    ctx.strokeStyle = stroke;
    ctx.beginPath();
    values.forEach((v,i)=>{
      const x = xAt(i);
      const y = yAt(v);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    ctx.fillStyle = stroke;
    values.forEach((v,i)=>{
      const x = xAt(i), y = yAt(v);
      ctx.beginPath();
      ctx.arc(x,y,3,0,Math.PI*2);
      ctx.fill();
    });
  }

  // sys and dia
  plotLine(pts.map(p=>p.sys), 'rgba(239,68,68,.85)');   // SYS
  plotLine(pts.map(p=>p.dia), 'rgba(11,108,240,.85)');  // DIA

  // legend
  ctx.fillStyle = 'rgba(239,68,68,.85)';
  ctx.fillText('SYS', padL, padT-2);
  ctx.fillStyle = 'rgba(11,108,240,.85)';
  ctx.fillText('DIA', padL+44, padT-2);
}

function buildKPI(records){
  const kpiEl = document.getElementById('kpi');
  if(!kpiEl) return;

  const total = records.length;
  const validCount = records.filter(r=>r.valid).length;
  const last = records.slice().sort((a,b)=> (b.ts||'').localeCompare(a.ts||''))[0];

  const avg = (arr)=> arr.length ? Math.round(arr.reduce((s,x)=>s+x,0)/arr.length) : '—';
  const sysArr = records.filter(r=>typeof r.sys==='number').map(r=>r.sys);
  const diaArr = records.filter(r=>typeof r.dia==='number').map(r=>r.dia);
  const pulseArr = records.filter(r=>typeof r.pulse==='number').map(r=>r.pulse);

  const lastTxt = last ? `${last.sys}/${last.dia}${typeof last.pulse==='number' ? ` • ${last.pulse} bpm` : ''}` : '—';

  kpiEl.innerHTML = `
    <div class="box">
      <div class="val">${lastTxt}</div>
      <div class="lbl">Ostatni pomiar</div>
    </div>
    <div class="box">
      <div class="val">${avg(sysArr)}/${avg(diaArr)}</div>
      <div class="lbl">Średnia (SYS/DIA)</div>
    </div>
    <div class="box">
      <div class="val">${avg(pulseArr)}</div>
      <div class="lbl">Średnie tętno</div>
    </div>
    <div class="box">
      <div class="val">${total} • ${total?Math.round((validCount/total)*100):0}%</div>
      <div class="lbl">Liczba • % „poprawnych”</div>
    </div>
  `;
}

function getFilters(){
  const rangeSel = document.getElementById('rangeSel');
  const sortSel = document.getElementById('sortSel');
  const onlyValid = document.getElementById('onlyValid');
  const searchNote = document.getElementById('searchNote');

  return {
    range: rangeSel ? rangeSel.value : 'all',
    sort: sortSel ? sortSel.value : 'desc',
    onlyValid: onlyValid ? onlyValid.value : 'all',
    search: normText(searchNote ? searchNote.value : '')
  };
}

function applyFilters(records){
  const f = getFilters();
  let out = records.slice();

  // range
  if(f.range !== 'all'){
    const days = Number(f.range);
    if(Number.isFinite(days) && days > 0){
      const from = new Date();
      from.setDate(from.getDate() - days);
      out = out.filter(r=>{
        const d = new Date(r.ts);
        return Number.isFinite(d.getTime()) && d >= from;
      });
    }
  }

  // only valid
  if(f.onlyValid === 'yes'){
    out = out.filter(r=>r.valid);
  }

  // search in note + context
  if(f.search){
    out = out.filter(r=>{
      const hay = [
        r.note, r.pos, r.mtype,
        r.rested ? 'odpoczynek' : '',
        r.meds ? 'leki' : '',
        r.valid ? 'poprawny' : 'niepoprawny'
      ].join(' ');
      return normText(hay).includes(f.search);
    });
  }

  // sort
  out.sort((a,b)=>{
    const aa = a.ts || '';
    const bb = b.ts || '';
    return f.sort === 'asc' ? aa.localeCompare(bb) : bb.localeCompare(aa);
  });

  return out;
}

function pillHTML(sys, dia, valid){
  const s = bpStatus(sys, dia);
  const extra = valid ? '' : ' style="opacity:.55"';
  return `<span class="pill ${s.key}"${extra}>${s.label}</span>`;
}

function valueHTML(sys, dia, valid){
  const s = bpStatus(sys, dia);
  const opacity = valid ? '' : 'opacity:.55;';
  return `<span class="pill ${s.key}" style="padding:0;border:0;background:transparent;${opacity}"><strong>${sys}</strong> / <strong>${dia}</strong></span>`;
}

function contextText(r){
  const parts = [
    r.mtype ? `typ: ${r.mtype}` : '',
    r.pos ? `poz: ${r.pos}` : '',
    r.rested ? 'po odpoczynku' : '',
    r.meds ? 'leki' : '',
    r.valid ? 'poprawny' : 'niepoprawny',
  ].filter(Boolean);
  return parts.join(' • ');
}

function render(){
  const all = loadRecords();
  const filtered = applyFilters(all);

  const countInfo = document.getElementById('countInfo');
  if(countInfo) countInfo.textContent = `Wyświetlane: ${filtered.length} / ${all.length}`;

  buildKPI(filtered);
  drawChart(filtered);

  const listWrap = document.getElementById('listWrap');
  if(!listWrap) return;

  if(filtered.length === 0){
    listWrap.innerHTML = `<div class="small muted" style="padding:10px 2px">Brak danych w wybranym filtrze.</div>`;
    return;
  }

  const rows = filtered.map(r=>{
    const note = safeStr(r.note).trim();
    const ctx = contextText(r);
    return `
      <tr>
        <td>
          <div><strong>${fmtDT(r.ts)}</strong></div>
          <div class="small">${ctx}</div>
        </td>
        <td>
          ${valueHTML(r.sys, r.dia, r.valid)}
          <div style="margin-top:6px">${pillHTML(r.sys, r.dia, r.valid)}</div>
        </td>
        <td>${typeof r.pulse === 'number' ? r.pulse : ''}</td>
        <td class="small">
          ${note ? note : '<span class="muted">—</span>'}
        </td>
        <td>
          <div class="actions">
            <button class="ghost" type="button" data-edit="${r.id}">Edytuj</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  listWrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Ciśnienie</th>
          <th>Tętno</th>
          <th>Notatka</th>
          <th>Akcje</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;

  // bind edit buttons
  listWrap.querySelectorAll('[data-edit]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      openEdit(btn.getAttribute('data-edit'));
    });
  });
}

/* ====== FORM (ADD) ====== */
const form = document.getElementById('measureForm');
const tsEl = document.getElementById('ts');
const sysEl = document.getElementById('sys');
const diaEl = document.getElementById('dia');
const pulseEl = document.getElementById('pulse');
const noteEl = document.getElementById('note');
const posEl = document.getElementById('pos');
const restedEl = document.getElementById('rested');
const medsEl = document.getElementById('meds');
const validEl = document.getElementById('valid');
const mtypeEl = document.getElementById('mtype');

const clearBtn = document.getElementById('clearBtn');
const resetAllBtn = document.getElementById('resetAll');
const copyLastBtn = document.getElementById('copyLast');

function resetForm(){
  tsEl.value = nowLocalISO();
  sysEl.value = '';
  diaEl.value = '';
  pulseEl.value = '';
  noteEl.value = '';
  posEl.value = '';
  restedEl.checked = false;
  medsEl.checked = false;
  validEl.checked = true;
  mtypeEl.value = 'domowy';
}

tsEl.value = nowLocalISO();

form.addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!form.checkValidity()){
    form.reportValidity();
    return;
  }

  const sys = Number(sysEl.value);
  const dia = Number(diaEl.value);
  const pulse = pulseEl.value === '' ? null : Number(pulseEl.value);

  const rec = {
    id: uid(),
    ts: tsEl.value,
    sys,
    dia,
    pulse,
    note: safeStr(noteEl.value).trim(),
    pos: posEl.value,
    rested: !!restedEl.checked,
    meds: !!medsEl.checked,
    valid: !!validEl.checked,
    mtype: mtypeEl.value,
    createdAt: new Date().toISOString()
  };

  const arr = loadRecords();
  arr.push(rec);
  saveRecords(arr);

  render();
  resetForm();
});

clearBtn.addEventListener('click', resetForm);

resetAllBtn.addEventListener('click', ()=>{
  if(confirm('Na pewno usunąć wszystkie pomiary?')){
    localStorage.removeItem(LS_KEY);
    render();
    resetForm();
  }
});

copyLastBtn.addEventListener('click', ()=>{
  const arr = loadRecords().sort((a,b)=> (b.ts||'').localeCompare(a.ts||''));
  const last = arr[0];
  if(!last) return;

  posEl.value = last.pos || '';
  restedEl.checked = !!last.rested;
  medsEl.checked = !!last.meds;
  validEl.checked = !!last.valid;
  mtypeEl.value = last.mtype || 'domowy';
});

/* ====== FILTERS ====== */
['rangeSel','sortSel','onlyValid','searchNote'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', render);
});

/* ====== EDIT DIALOG ====== */
const editDlg = document.getElementById('editDlg');
const dlgClose = document.getElementById('dlgClose');
const dlgCancel = document.getElementById('dlgCancel');
const dlgSave = document.getElementById('dlgSave');
const dlgDelete = document.getElementById('dlgDelete');

const d_ts = document.getElementById('d_ts');
const d_sys = document.getElementById('d_sys');
const d_dia = document.getElementById('d_dia');
const d_pulse = document.getElementById('d_pulse');
const d_note = document.getElementById('d_note');
const d_pos = document.getElementById('d_pos');
const d_rested = document.getElementById('d_rested');
const d_meds = document.getElementById('d_meds');
const d_valid = document.getElementById('d_valid');
const d_mtype = document.getElementById('d_mtype');

let editingId = null;

function openEdit(id){
  const arr = loadRecords();
  const rec = arr.find(x=>x.id === id);
  if(!rec) return;

  editingId = id;
  d_ts.value = rec.ts || nowLocalISO();
  d_sys.value = rec.sys ?? '';
  d_dia.value = rec.dia ?? '';
  d_pulse.value = (typeof rec.pulse === 'number') ? rec.pulse : '';
  d_note.value = rec.note || '';
  d_pos.value = rec.pos || '';
  d_rested.checked = !!rec.rested;
  d_meds.checked = !!rec.meds;
  d_valid.checked = !!rec.valid;
  d_mtype.value = rec.mtype || 'domowy';

  editDlg.showModal();
}

function closeEdit(){
  editingId = null;
  editDlg.close();
}

dlgClose.addEventListener('click', closeEdit);
dlgCancel.addEventListener('click', closeEdit);

dlgSave.addEventListener('click', ()=>{
  if(!editingId) return;

  // walidacja minimalna
  if(d_ts.value === '' || d_sys.value === '' || d_dia.value === ''){
    alert('Uzupełnij datę, SYS i DIA.');
    return;
  }

  const arr = loadRecords();
  const i = arr.findIndex(x=>x.id === editingId);
  if(i < 0) return;

  arr[i] = {
    ...arr[i],
    ts: d_ts.value,
    sys: Number(d_sys.value),
    dia: Number(d_dia.value),
    pulse: d_pulse.value === '' ? null : Number(d_pulse.value),
    note: safeStr(d_note.value).trim(),
    pos: d_pos.value,
    rested: !!d_rested.checked,
    meds: !!d_meds.checked,
    valid: !!d_valid.checked,
    mtype: d_mtype.value,
    updatedAt: new Date().toISOString()
  };

  saveRecords(arr);
  closeEdit();
  render();
});

dlgDelete.addEventListener('click', ()=>{
  if(!editingId) return;
  if(!confirm('Usunąć ten pomiar?')) return;

  const arr = loadRecords().filter(x=>x.id !== editingId);
  saveRecords(arr);
  closeEdit();
  render();
});

/* ====== EXPORT / IMPORT ====== */
document.getElementById('exportJson').addEventListener('click', ()=>{
  const arr = loadRecords();
  downloadFile('bp_backup.json', JSON.stringify(arr, null, 2), 'application/json');
});

document.getElementById('importJsonBtn').addEventListener('click', ()=>{
  document.getElementById('importJson').click();
});
document.getElementById('importJson').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const txt = await file.text();
  try{
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw new Error('Zły format');
    saveRecords(arr);
    render();
    resetForm();
    alert('Przywrócono JSON.');
  }catch(err){
    alert('Nie udało się wczytać JSON: ' + err.message);
  }finally{
    e.target.value = '';
  }
});

function toCSVRow(cols){
  return cols.map(v=>{
    const s = safeStr(v);
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }).join(',');
}

document.getElementById('exportCsv').addEventListener('click', ()=>{
  const arr = loadRecords();
  const header = ['id','ts','sys','dia','pulse','mtype','pos','rested','meds','valid','note'];
  const lines = [
    toCSVRow(header),
    ...arr.map(r=>toCSVRow([
      r.id, r.ts, r.sys, r.dia,
      (typeof r.pulse==='number'?r.pulse:''),
      r.mtype, r.pos,
      r.rested?1:0, r.meds?1:0, r.valid?1:0,
      r.note
    ]))
  ];
  downloadFile('bp_export.csv', lines.join('\n'), 'text/csv;charset=utf-8');
});

document.getElementById('importCsvBtn').addEventListener('click', ()=>{
  document.getElementById('importCsv').click();
});
document.getElementById('importCsv').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const txt = await file.text();

  // prosty parser csv (bez egzotycznych edge-case)
  const lines = txt.split(/\r?\n/).filter(Boolean);
  if(lines.length < 2){ alert('CSV pusty'); return; }

  const header = lines[0].split(',').map(s=>s.trim());
  const idx = (name)=> header.indexOf(name);

  const out = [];
  for(let i=1;i<lines.length;i++){
    const line = lines[i];
    const cols = [];
    let cur = '', inQ = false;
    for(let j=0;j<line.length;j++){
      const ch = line[j];
      if(ch === '"' ){
        if(inQ && line[j+1] === '"'){ cur += '"'; j++; }
        else inQ = !inQ;
      } else if(ch === ',' && !inQ){
        cols.push(cur); cur='';
      } else cur += ch;
    }
    cols.push(cur);

    const rec = {
      id: cols[idx('id')] || uid(),
      ts: cols[idx('ts')] || nowLocalISO(),
      sys: Number(cols[idx('sys')]),
      dia: Number(cols[idx('dia')]),
      pulse: cols[idx('pulse')] === '' ? null : Number(cols[idx('pulse')]),
      mtype: cols[idx('mtype')] || 'domowy',
      pos: cols[idx('pos')] || '',
      rested: cols[idx('rested')] === '1',
      meds: cols[idx('meds')] === '1',
      valid: cols[idx('valid')] !== '0',
      note: cols[idx('note')] || ''
    };

    if(Number.isFinite(rec.sys) && Number.isFinite(rec.dia)) out.push(rec);
  }

  saveRecords(out);
  render();
  resetForm();
  alert('Zaimportowano CSV.');
  e.target.value = '';
});

/* ====== PRINT ====== */
document.getElementById('printReport').addEventListener('click', ()=>window.print());
document.getElementById('printDoctor').addEventListener('click', ()=>{
  // na teraz robi print z filtrami; docFrom/docTo możesz dopiąć później do applyFilters
  window.print();
});

/* ====== INIT ====== */
render();
</script>

</body>
</html>
